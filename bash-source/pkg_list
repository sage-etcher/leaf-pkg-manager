#  
#  This source file is a part of the Leaf Package Manager.
#  https://github.com/sage-etcher/leaf-pkg-manager
# 
#  /bash_source/pkg_list
#  A bash script to list all locally available packages.
# 
#  
#
#  
#  Copyright 2023-2024 Sage I. Hendricks
# 
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
# 
#      http://www.apache.org/licenses/LICENSE-2.0
# 
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
# 
#  
#
#  
#  email:  sage.message@email.com
#  github: sage-etcher
# 
#  


#!/bin/bash

# PKG_TRACES_PATH & PKG_ARCHIVE_PATH must be set
. pkg_init
if [ -z "$PKG_TRACES_PATH" ] &&
   [ -z "$PKG_ARCHIVE_PATH" ]
then
    echo "ERROR: package enviorment variables are not set"
    exit -1
fi

# no params

# make sure that the package directories exist
if [ ! -d "$PKG_TRACES_PATH" ] ||
   [ ! -d "$PKG_ARCHIVE_PATH" ]
then
    echo "ERROR: package directories could not be accessed"
    exit -1
fi

# get directory contents
LF="
"

packages=
packages_raw=$(basename -s .tar.xz -a $(find "$PKG_ARCHIVE_PATH" -type f -name "*.tar.xz"))
for pkg in $packages_raw; do
    packages="\033[0;37m$pkg$LF$packages"
done

package_aliases_raw=$(find "$PKG_ARCHIVE_PATH" -type l -name "*.tar.xz")
for pkg_alias in $package_aliases_raw; do
    package_name=$(basename -s .tar.xz "$pkg_alias")
    package_link=$(basename -s .tar.xz $(readlink "$pkg_alias"))
    packages="\033[0;37m$package_name\033[1;34m($package_link)$LF$packages"
done

packages_sorted=$(echo "$packages" | sort | grep -v -e '^[[:space:]]*$' -)
echo -e "$packages_sorted"

# exit the program successfully
exit 0
